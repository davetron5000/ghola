#!/bin/sh

set -e

if [ "$1" = "help" ] || [ "$1" = "-h" ]; then
  echo "usage: $0 [dev|test|prod]"
  exit 0
fi

ENV=$1
if [ -z "${ENV}" ]; then
  ENV=dev
fi


APP_VERSION=init

if [ "${ENV}" = "dev" ]; then
  echo "Building JavaScript"
  npx esbuild  \
    --bundle  \
    --define:ENV=\"dev\" \
    --define:APP_VERSION=\"${APP_VERSION}\" \
    --keep-names \
    --outfile=serve/dev/main.js \
    --sourcemap \
    src/js/index.js
  echo "Building CSS"

  npx esbuild \
    --sourcemap \
    --bundle \
    --outfile=serve/dev/main.css \
    src/css/index.css

  echo "Copying HTML"
  cp src/html/*.html serve/dev
  cp src/images/*.ico serve/dev
  cp src/images/*.png serve/dev

else
  if [ "${ENV}" = "production" ]; then
    echo "Building JavaScript"
    npx esbuild  \
      --bundle  \
      --define:ENV=\"production\" \
      --define:APP_VERSION=\"${APP_VERSION}\" \
      --keep-names \
      --outfile=docs/main.js \
      --minify \
      --sourcemap \
      src/js/index.js

    echo "Building CSS"

    npx esbuild \
      --sourcemap \
      --bundle \
      --minify \
      --outfile=docs/main.css \
      src/css/index.css

    echo "Copying HTML"
    cp src/html/*.html docs
    cp src/images/*.ico docs
    cp src/images/*.png docs
  else

    echo "Not implemented"
    exit 1
  fi
fi
