#!/bin/bash

set -e

if [ "$1" = "help" ] || [ "$1" = "-h" ]; then
  echo "usage: $0 [dev|test|prod]"
  exit 0
fi

ENV=$1
if [ -z "${ENV}" ]; then
  ENV=dev
fi


APP_VERSION=init

build_js() {
  infile="${1}"
  outfile="${2}"
  env="${3}"
  rest="${@:4}"

  echo "Building JavaScript for '${env}' to '${outfile}'"
  npx esbuild  \
    --bundle  \
    --define:ENV=\"${env}\" \
    --define:APP_VERSION=\"${APP_VERSION}\" \
    --keep-names \
    --outfile="${outfile}" \
    --sourcemap \
    ${rest} src/js/"${infile}"
}

if [ "${ENV}" = "dev" ]; then
  build_js index.js serve/dev/main.js dev
  build_js albers.js serve/dev/albers.js dev

  echo "Building CSS"

  npx esbuild \
    --sourcemap \
    --bundle \
    --outfile=serve/dev/main.css \
    src/css/index.css

  echo "Copying HTML"
  rsync -a src/html/ serve/dev

  echo "Copying images"
  cp src/images/*.ico serve/dev
  cp src/images/*.png serve/dev

else
  if [ "${ENV}" = "production" ]; then
    echo "Building JavaScript"
    build_js index.js docs/main.js production --minify
    build_js albers.js docs/albers.js production --minify

    echo "Building CSS"

    npx esbuild \
      --sourcemap \
      --bundle \
      --minify \
      --outfile=docs/main.css \
      src/css/index.css

    echo "Copying HTML"
    rsync -a src/html/ docs

    echo "Copying images"
    cp src/images/*.ico docs
    cp src/images/*.png docs
  else

    echo "Not implemented"
    exit 1
  fi
fi
